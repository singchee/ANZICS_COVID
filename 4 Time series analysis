#assign time series labels


#get estimates from ME regression without pandemic perioid adjustment

mod_ts = glmer(DIED_HOSP ~ ANZRODRiskofDeath_old + HospitalClassification + series_month + (1|SiteID), data=df3, family=binomial, control = glmerControl(optimizer = "bobyqa"), nAGQ = 0)


#get monthly estimates from Mixed Effects regression

its = mod_ts %>%
    tidy(effects = "fixed", conf.int = TRUE)%>% #extract fixed effect estimats
    filter(str_detect(term, "series_month")) %>% #filter out predictors that have "series" 
    mutate(across(c(estimate, starts_with("conf")), exp)) %>% #exponentiate estaimates and CI to get OR
    mutate(series = seq_along(1:nrow(.)), pandperiod = ifelse(series>=38, 1, 0)) #generate  month series and pandemic period (month 39 is series 38 due to reference category)


#plotting adjusted 

mod_ts %>%
    tidy(effects = "fixed", conf.int = TRUE)%>% #extract fixed effect estimats
    filter(str_detect(term, "series_month")) %>% #filter out predictors that have "series" 
    mutate(across(c(estimate, starts_with("conf")), exp)) %>% #exponentiate estaimates and CI to get OR
    mutate(series = seq_along(1:nrow(.)))  %>% #generate monthly sequence
    ggplot(aes(series, estimate))+ #plot
    geom_point() +
    geom_smooth() +
    geom_linerange(aes(ymin = conf.low, ymax = conf.high)) +
    scale_x_continuous(breaks = scales::breaks_width(2))+
    geom_vline(xintercept = 39, linetype="dotted",color = "blue", size=1) +
    ylim(0.6, 1.4) + 
    ylab("Adjusted Odds of Death") +
    xlab("Month of Admission") +
    ggtitle("Adjusted OR of Death Over Time (All Patients)")+
    annotate(geom="text", x=45, y=1.2,label="Pandemic Period",color="Black")

#ITS using its.analysis

me_coeff=as.data.frame(me_coeff)

#TS using adjusted from Mixef effect regression
ts= est %>% 
    mutate(
    pandemic=ifelse(series < 39, 0, 1)) %>%
    group_by(series) %>%
    mutate(
        series_month = cur_group_id()) %>% # generate month sequence %>%
    group_by(pandemic) %>%
    mutate(series_pand = match(series, unique(series))) %>%
    mutate(series = seq_along(1:nrow(.)), pandperiod = ifelse(series>=38, 1, 0)) #generate  month series and pandemic period (month 39 is series 38 due to reference category)

#check for autocorrelation
library(car)
durbinWatsonTest(ts)
act(resid(ts))

ts_model=glm(estimate ~ series + series_pand + pandemic, ts, family=gaussian())


install.packages("lmtest")



tab=stargazer(ts, 
+           type="text",
+           dep.var.labels = ("SMR"),
+           column.labels = ("Results"),
+           covariate.labels = c("Time", "Pandemic Period Start", "Time since Pandemic Started"),
+           omit.stat="all",
+           digits=2)


#IGNORE BELOW#


df3=df3 %>%
    arrange(ICU_AD_DTM) %>%
    mutate(pandemicperiod = dplyr::if_else(as.Date(ICU_AD_DTM)>=as.Date("2020-03-01"), 1, 0)) %>%
    group_by(pandemicperiod) %>%
    mutate(pandseries = seq_along(pandemicperiod)) %>%
    mutate(pandseries = ifelse(pandemicperiod == "0", 0, pandseries))
    
#build time series
ts=lm(SMR ~ series + pandperiod + pandseries, df5)
confint(m_its)
library(stargazer)
tab=stargazer(ts, 
+           type="text",
+           dep.var.labels = ("SMR"),
+           column.labels = ("Results"),
+           covariate.labels = c("Time", "Pandemic Period Start", "Time since Pandemic Started"),
+           omit.stat="all",
+           digits=2)



#group data by day month and calculate SMR

 smr_day=ds3 %>%
     filter(state_subgroup== 0) %>%
     mutate(date=as.Date(ICU_AD_DTM),year = year(ICU_AD_DTM), month = month(ICU_AD_DTM)) %>%
     group_by(date) %>%
     summarise(SMR = mean(DIED_HOSP)/mean(ANZRODRiskofDeath_old)) %>%
     arrange(date) %>%
     mutate(year = year(date), month = month(date)) %>% 
     mutate(date_mth=as.Date(zoo::as.yearmon(paste(.data$year, .data$month, sep="-")) )

library(zoo)

#assign valid dates to each month

smr_month = smr_day %>%
     mutate(year = year(date), month = month(date)) %>%
     group_by(month, year) %>%
     summarise(SD = sd(SMR), SMR_mth = mean(SMR), n=n(), se=SD/n) %>%
     mutate(date=as.Date(zoo::as.yearmon(paste(.data$year, .data$month, sep="-"))))


#assign time series variables
smr_month = 
	smr_month %>% 
	mutate(date=as.Date(zoo::as.yearmon(paste(.data$year, .data$month, sep="-")))) %>%	
    mutate(pandperiod = dplyr::if_else(date>=as.Date("2020-03-01"), 1, 0)) %>%
    group_by(pandperiod) %>% 
    mutate(pandseries = seq_along(pandperiod), series =1:nrow(.))

df4$series= 1:nrow(df4)
df4$pandseries=ifelse(df4$pandperiod == "0", "0", df4$pandseries)

#Generate daily SMR calculations + timeseries
smr_day = dataset_ewma_overall %>%
     group_by(AD_Date = as.Date(ICU_AD_DTM)) %>%
     summarise(SMR = mean(DIED_HOSP)/mean(ANZRODRiskofDeath_old), 
               ANZROD_old = mean(ANZRODRiskofDeath_old), 
	                      hosp_mortality = mean(DIED_HOSP)) %>%
     mutate(pandperiod = if_else(AD_Date>=as.Date("2020-03-01"), 1, 0), series= 1:nrow(.)) %>%
     group_by(pandperiod) %>%
     mutate(pandseries = seq_along(pandperiod))

#SMR plot
ggplot(df5, aes(x=date,y=SMR, group=1)) + 
    geom_line() + 
    ylim(0.8, 1) + 
    theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
    geom_vline(xintercept = as.Date("2020-03-01"), linetype="dotted",color = "blue", size=1)+
    geom_smooth(method = "lm", aes(group=pandperiod)) +
    annotate(geom="text", x=as.Date("2020-10-01"), y=1,label="Pandemic period",color="red")




#Repeat for NSW+VIC+ACT
sub_state=df3 %>%
	filter(state_subgroup =="1") %>%
    mutate(year = year(ICU_AD_DTM), month = month(ICU_AD_DTM)) %>%
    group_by(month, year) %>%
    summarise(SMR = mean(DIED_HOSP)/mean(ANZROD)) %>%
    arrange(year, month) 
    
sub_state$yymm=paste(sub_state$year, sub_state$month, sep="-")
sub_state$date=as.Date(zoo::as.yearmon(df4$yymm))
sub_state=sub_state %>%
    mutate(pandperiod = dplyr::if_else(date>=as.Date("2020-03-01"), 1, 0)) %>%
    mutate (pandseries = ifelse(pandperiod == 0, 0, 1:n()))
    
    
 sub_state=sub_state %>%
    mutate(pandperiod = dplyr::if_else(date>=as.Date("2020-03-01"), 1, 0)) %>%
    group_by(pandperiod) %>%
    mutate(pandseries = seq_along(pandperiod))

sub_state$pandseries=ifelse(sub_state$pandperiod == "0", "0", sub_state$pandseries)
sub_state$series= 1:nrow(sub_state)

ggplot(smr_month, aes(x=as.Date(YYMM),y=SMR, group=1)) + 
     geom_line() + 
     ylim(0.8, 1) + 
     theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1)) + 
     geom_vline(xintercept = as.Date("2020-03-01"), linetype="dotted",color = "blue", size=1)+
     geom_smooth(method = "lm", aes(group=pandperiod)) +
     geom_smooth(method = "lm", aes(group=segment), linetype="dashed", color ="red") +
     annotate(geom="text", x=as.Date("2020-10-01"), y=1,label="Pandemic period",color="red")
