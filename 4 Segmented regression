
#segmented analysis
seg.fit = lm(ts ~ series_month, data= ts_noseason_df2)
segmented.fit <- segmented(seg.fit, seg.Z = ~series, psi=58) #guesstimated change in around month 58 (nov 2020) from visual plots
slope(segmented.fit)
summary(segmented.fit)

ts_noseason_df2 = ts_noseason_df2 %>%
    mutate(bp= ifelse(series_month >=65, 1, 0))  %>%
          group_by(bp) %>%
           mutate(series_bp = match(date, unique(date))) %>%
          mutate(series_bp = ifelse(bp == 0, 0, series_bp))
 
 its_data = ts_noseason_df2

its_mod=lm(ts ~ series_month + bp + series_bp, data=its_data)
summary(its_mod)

#save OR estimates as table 



plot_all= m1_all %>%
          tidy(effects = "fixed", conf.int = TRUE)%>% #extract fixed effect estimats
          filter(str_detect(term, "series")) %>% #filter out predictors that have "series" 
         mutate(across(c(estimate, starts_with("conf")), exp)) %>% #exponentiate estaimates and CI to get OR
          mutate(series = seq_along(1:nrow(.))) 

seg.fit = lm(estimate ~ series, data= m1_plot)

segmented.fit <- segmented(seg.fit, seg.Z = ~series, psi=58) #guesstimated change in around month 58 (nov 2020) from visual plots
slope(segmented.fit)
summary(segmented.fit)
